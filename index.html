<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bus Tracker Live</title>

        <!-- TailwindCSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Leaflet CSS & JS -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <!-- Socket.IO -->
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

        <style>
            #map {
                height: 80vh;
            }
            .bus-popup {
                min-width: 200px;
            }
        </style>
    </head>
    <body class="bg-gray-100 flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-indigo-600 text-white py-4 shadow-md">
            <h1 class="text-center text-2xl sm:text-3xl font-bold">
                ðŸšŒ Bus Tracker Live
            </h1>
        </header>

        <!-- Controls -->
        <div
            class="flex flex-col sm:flex-row items-center justify-center gap-3 p-4 bg-white shadow-md"
        >
            <input
                type="text"
                id="busId"
                placeholder="Enter Bus ID"
                class="border rounded-lg px-4 py-2 w-full sm:w-1/3 focus:ring-2 focus:ring-indigo-500 outline-none"
            />
            <button
                id="findBtn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg shadow-md transition-all"
            >
                Start Tracking
            </button>
            <span
                id="status"
                class="text-gray-700 text-sm sm:text-base ml-2"
            ></span>
        </div>

        <!-- Map -->
        <div id="map" class="w-full flex-1 shadow-inner"></div>

        <script>
            const map = L.map("map").setView([20.5937, 78.9629], 5);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
            }).addTo(map);

            const socket = io("https://bus-tracker-server-ajmu.onrender.com"); // Replace with your server

            const busIcon = L.icon({
                iconUrl: "https://img.icons8.com/color/48/000000/bus.png",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -25],
            });

            let busMarker = null;
            let trackingBusId = null;
            const statusEl = document.getElementById("status");
            const findBtn = document.getElementById("findBtn");

            function startTracking() {
                trackingBusId = document.getElementById("busId").value.trim();
                if (!trackingBusId) {
                    statusEl.textContent = "Enter a Bus ID";
                    return;
                }
                statusEl.textContent = `Tracking bus ${trackingBusId}...`;
                findBtn.textContent = "Stop Tracking";
                findBtn.classList.add("stop");
            }

            function stopTracking() {
                trackingBusId = null;
                statusEl.textContent = "Tracking stopped";
                findBtn.textContent = "Start Tracking";
                findBtn.classList.remove("stop");
                if (busMarker) {
                    map.removeLayer(busMarker);
                    busMarker = null;
                }
            }

            findBtn.addEventListener("click", () => {
                if (!trackingBusId) startTracking();
                else stopTracking();
            });

            socket.on("busLocationUpdate", (data) => {
                if (!trackingBusId || data.busId !== trackingBusId) return;

                const lat = data.latitude;
                const lng = data.longitude;
                const timestamp = data.timestamp; // Assume already in IST

                if (!lat || !lng || !timestamp) return;

                const popupContent = `
        <div class="bus-popup p-2">
          <div class="font-semibold text-indigo-700 text-lg">Bus: ${data.busId}</div>
          <div class="text-gray-700">Lat: ${lat.toFixed(5)}</div>
          <div class="text-gray-700">Lng: ${lng.toFixed(5)}</div>
          <div class="text-gray-600">Time (IST): ${timestamp}</div>
        </div>
      `;

                if (!busMarker) {
                    busMarker = L.marker([lat, lng], { icon: busIcon })
                        .addTo(map)
                        .bindPopup(popupContent)
                        .openPopup();
                    map.setView([lat, lng], 15);
                } else {
                    busMarker.setLatLng([lat, lng]);
                    busMarker.getPopup().setContent(popupContent);
                }

                statusEl.textContent = `Bus ${data.busId} at ${lat.toFixed(5)}, ${lng.toFixed(5)} (Time: ${timestamp})`;
            });
        </script>
    </body>
</html>
