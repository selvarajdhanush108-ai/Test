<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bus Tracker Live</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                height: 100%;
            }
            #map {
                height: 90%;
                width: 100%;
            }
            #topbar {
                height: 10%;
                display: flex;
                align-items: center;
                padding: 5px;
                gap: 5px;
                background: #f0f0f0;
            }
            input {
                padding: 5px;
                font-size: 16px;
            }
            button {
                padding: 5px 10px;
                font-size: 16px;
            }
            button.stop {
                color: red;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div id="topbar">
            <input type="text" id="busId" placeholder="Enter Bus ID" />
            <button id="findBtn">Start Tracking</button>
            <span id="status"></span>
        </div>

        <div id="map"></div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            const streetLayer = L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
                    attribution: "&copy; OpenStreetMap contributors",
                },
            );

            const satelliteLayer = L.tileLayer(
                "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
                { attribution: "&copy; OpenTopoMap contributors" },
            );

            const map = L.map("map", {
                center: [20.5937, 78.9629],
                zoom: 5,
                layers: [streetLayer],
            });

            L.control
                .layers({ Street: streetLayer, Satellite: satelliteLayer })
                .addTo(map);

            const busIcon = L.icon({
                iconUrl: "https://img.icons8.com/color/48/000000/bus.png",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
            });

            let busMarker = null;
            const statusEl = document.getElementById("status");
            const findBtn = document.getElementById("findBtn");
            let trackingInterval = null;
            let isTracking = false;

            async function fetchBusLocation(busId) {
                try {
                    const res = await fetch(
                        `https://bus-track-68bq.onrender.com/bus/${encodeURIComponent(busId)}`,
                    );
                    if (!res.ok) {
                        statusEl.textContent = `Server returned ${res.status}`;
                        return;
                    }
                    const data = await res.json();

                    const lat =
                        data.latitude ??
                        data.lat ??
                        data[0]?.latitude ??
                        data[0]?.lat;
                    const lng =
                        data.longitude ??
                        data.lng ??
                        data[0]?.longitude ??
                        data[0]?.lng;
                    let timestamp =
                        data.timestamp ??
                        data.time ??
                        data[0]?.timestamp ??
                        new Date().toISOString();

                    if (lat == null || lng == null) {
                        statusEl.textContent =
                            "Could not extract latitude/longitude from API response.";
                        console.log("API Response:", data);
                        return;
                    }

                    // Convert timestamp to Indian Standard Time (IST)
                    const dateObj = new Date(timestamp);
                    const istOffset = 5.5 * 60; // IST is UTC+5:30 in minutes
                    const istDate = new Date(
                        dateObj.getTime() + istOffset * 60000,
                    );

                    // Format date
                    const day = istDate.getDate().toString().padStart(2, "0");
                    const month = (istDate.getMonth() + 1)
                        .toString()
                        .padStart(2, "0");
                    const year = istDate.getFullYear();

                    // Format time in 12-hour
                    const hours = istDate.getHours();
                    const minutes = istDate
                        .getMinutes()
                        .toString()
                        .padStart(2, "0");
                    const ampm = hours >= 12 ? "PM" : "AM";
                    const hours12 = hours % 12 === 0 ? 12 : hours % 12;

                    const formattedDateTime = `${day}-${month}-${year} ${hours12}:${minutes} ${ampm}`;
                    timestamp = formattedDateTime;

                    if (!busMarker) {
                        busMarker = L.marker([lat, lng], {
                            icon: busIcon,
                        }).addTo(map);
                    } else {
                        busMarker.setLatLng([lat, lng]);
                    }

                    busMarker
                        .bindPopup(
                            `Bus ${busId}<br>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}<br>Time: ${timestamp}`,
                        )
                        .openPopup();

                    map.setView([lat, lng], 15);
                    statusEl.textContent = `Bus ${busId} at ${lat.toFixed(5)}, ${lng.toFixed(5)} (Time: ${timestamp})`;
                } catch (err) {
                    console.error(err);
                    statusEl.textContent =
                        "Error fetching bus location (check CORS & network).";
                }
            }

            findBtn.addEventListener("click", () => {
                const busId = document.getElementById("busId").value.trim();
                if (!busId) {
                    statusEl.textContent = "Enter a bus ID";
                    return;
                }

                if (!isTracking) {
                    fetchBusLocation(busId);
                    trackingInterval = setInterval(
                        () => fetchBusLocation(busId),
                        10000,
                    );
                    isTracking = true;
                    findBtn.textContent = "Stop Tracking";
                    findBtn.classList.add("stop");
                    statusEl.textContent = `Tracking bus ${busId}...`;
                } else {
                    clearInterval(trackingInterval);
                    trackingInterval = null;
                    isTracking = false;
                    findBtn.textContent = "Start Tracking";
                    findBtn.classList.remove("stop");
                    statusEl.textContent = `Tracking stopped for bus ${busId}.`;
                }
            });
        </script>
    </body>
</html>
