<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Passenger Map ‚Äì Bus Proximity Alert</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (OSM) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; background:#0b1220; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { position: absolute; inset: 0; }
    .panel {
      position: fixed; left: 8px; right: 8px; bottom: 8px;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: 1 1 auto; min-width: 120px; }
    input, button {
      border-radius: 10px; border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06); color: #fff; padding: 10px 12px;
    }
    button { cursor: pointer; font-weight: 600; }
    .tag { font-size: 12px; opacity: 0.85; }
    .pill { display:inline-block; padding:4px 10px; background:#1e293b; border-radius:999px; border:1px solid rgba(255,255,255,0.08); }
    .distance { font-size: 14px; }
    .toast {
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      background: #22c55e; color:#0a0a0a; padding:10px 14px; border-radius:999px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3); font-weight: 700; display:none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="row" style="margin-bottom:8px">
      <button id="btnEnable" style="flex:0 0 auto">Enable sound & sensors</button>
      <span class="tag pill">Status: <span id="status">idle</span></span>
      <span class="tag pill">Distance: <span id="distance" class="distance">‚Äî</span></span>
    </div>
    <div class="row" style="margin-bottom:8px">
      <input id="apiUrl" placeholder="Bus API URL (optional, returns { lat, lng })" />
      <input id="threshold" type="number" value="300" min="50" step="50" />
      <label class="tag">Alert within meters</label>
    </div>
    <div class="row">
      <button id="btnStart">Start tracking</button>
      <button id="btnStop" style="background:#ef4444;">Stop</button>
      <button id="btnCenter">Center on me</button>
    </div>
    <div class="tag" style="margin-top:8px; line-height:1.4">
      ‚Ä¢ Without API URL, bus position is simulated around you.<br/>
      ‚Ä¢ With API URL, provide an endpoint that returns: <code>{"lat":12.34,"lng":56.78}</code>
    </div>
  </div>

  <div class="toast" id="toast">Bus is near! üöçüîî</div>

  <script>
    // ---- Map setup ----
    const map = L.map('map', { zoomControl: false });
    L.control.zoom({ position: 'topright' }).addTo(map);

    const tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap',
    }).addTo(map);

    let userMarker = null;
    let busMarker = null;
    let userLatLng = null;
    let busLatLng = null;

    // Icons (simple colored circles)
    const userIcon = L.divIcon({
      className: '',
      html: '<div style="width:16px;height:16px;background:#3b82f6;border:2px solid white;border-radius:50%"></div>',
      iconSize: [16,16],
      iconAnchor: [8,8]
    });
    const busIcon = L.divIcon({
      className: '',
      html: '<div style="width:18px;height:18px;background:#f59e0b;border:2px solid white;border-radius:4px"></div>',
      iconSize: [18,18],
      iconAnchor: [9,9]
    });

    // ---- Controls and state ----
    const statusEl = document.getElementById('status');
    const distanceEl = document.getElementById('distance');
    const apiUrlEl = document.getElementById('apiUrl');
    const thresholdEl = document.getElementById('threshold');
    const toastEl = document.getElementById('toast');

    let watchId = null;
    let busTimer = null;
    let audioReady = false;
    let audioCtx = null;
    let lastAlertTime = 0;

    function setStatus(s){ statusEl.textContent = s; }

    // ---- Sound (Web Audio buzzer) ----
    function ensureAudio() {
      if (audioReady) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioReady = true;
      } catch(e) {
        console.warn('Audio not available', e);
      }
    }
    function buzzer(durationMs = 2500, freq = 1000) {
      if (!audioReady || !audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square';
      o.frequency.value = freq;
      g.gain.value = 0.2;
      o.connect(g).connect(audioCtx.destination);
      o.start();
      setTimeout(() => o.stop(), durationMs);
    }

    // ---- Toast ----
    function showToast(msg, ms=1500){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=>toastEl.style.display='none', ms);
    }

    // ---- Vibrate helper ----
    function buzzVibrate() {
      if (navigator.vibrate) {
        navigator.vibrate([400, 200, 400, 200, 800]);
      }
    }

    // ---- Distance helper using Leaflet ----
    function computeDistanceMeters(a, b) {
      if (!a || !b) return null;
      return a.distanceTo(b); // meters
    }

    // ---- Update markers ----
    function updateUserMarker(lat, lng) {
      userLatLng = L.latLng(lat, lng);
      if (!userMarker) {
        userMarker = L.marker(userLatLng, { icon: userIcon }).addTo(map);
        map.setView(userLatLng, 15);
      } else {
        userMarker.setLatLng(userLatLng);
      }
    }
    function updateBusMarker(lat, lng) {
      busLatLng = L.latLng(lat, lng);
      if (!busMarker) {
        busMarker = L.marker(busLatLng, { icon: busIcon }).addTo(map);
      } else {
        busMarker.setLatLng(busLatLng);
      }
    }

    // ---- Proximity check ----
    function checkProximity() {
      const d = computeDistanceMeters(userLatLng, busLatLng);
      if (d == null) { distanceEl.textContent = '‚Äî'; return; }
      const meters = Math.round(d);
      const km = (meters/1000).toFixed(meters >= 1000 ? 2 : 3);
      distanceEl.textContent = meters < 1000 ? meters + ' m' : km + ' km';

      const threshold = Math.max(50, parseInt(thresholdEl.value || '300', 10));
      const now = Date.now();
      if (meters <= threshold && now - lastAlertTime > 15000) {
        lastAlertTime = now;
        showToast('Bus is near! üöç');
        buzzer(2500, 900);
        buzzVibrate();
      }
    }

    // ---- Geolocation ----
    function startUserWatch() {
      if (!('geolocation' in navigator)) {
        alert('Geolocation not supported on this device/browser.');
        return;
      }
      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          updateUserMarker(latitude, longitude);
          checkProximity();
        },
        (err) => setStatus('Location error: ' + err.message),
        { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
      );
      setStatus('tracking');
    }

    function stopUserWatch() {
      if (watchId != null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      setStatus('stopped');
    }

    // ---- Bus data: API fetch or simulation ----
    async function fetchBusFromApi(url) {
      const res = await fetch(url, { cache: 'no-store' });
      const j = await res.json();
      if (typeof j.lat === 'number' && typeof j.lng === 'number') {
        updateBusMarker(j.lat, j.lng);
      }
    }

    // Simple simulation: bus circles around user's location
    let angle = 0;
    function simulateBus() {
      if (!userLatLng) return;
      angle += 8; // degrees per tick
      const rMeters = 400; // radius
      const dLat = (rMeters / 111111) * Math.cos(angle * Math.PI/180);
      const dLng = (rMeters / (111111 * Math.cos(userLatLng.lat * Math.PI/180))) * Math.sin(angle * Math.PI/180);
      const lat = userLatLng.lat + dLat;
      const lng = userLatLng.lng + dLng;
      updateBusMarker(lat, lng);
    }

    function startBusLoop() {
      const url = (apiUrlEl.value || '').trim();
      if (busTimer) clearInterval(busTimer);
      busTimer = setInterval(async () => {
        try {
          if (url) {
            await fetchBusFromApi(url);
          } else {
            simulateBus();
          }
          checkProximity();
        } catch (e) {
          console.warn('Bus fetch/sim error:', e);
        }
      }, 3000);
    }
    function stopBusLoop() {
      if (busTimer) clearInterval(busTimer);
      busTimer = null;
    }

    // ---- Buttons ----
    document.getElementById('btnEnable').addEventListener('click', async () => {
      ensureAudio();
      try {
        // poke audio context on mobile
        await (audioCtx && audioCtx.resume ? audioCtx.resume() : Promise.resolve());
      } catch {}
      // ask for a one-time geolocation to center quickly
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            updateUserMarker(pos.coords.latitude, pos.coords.longitude);
            map.setView([pos.coords.latitude, pos.coords.longitude], 15);
            showToast('Ready! Sound & sensors enabled.', 1200);
          },
          () => {},
          { enableHighAccuracy: true, timeout: 8000 }
        );
      }
    });

    document.getElementById('btnStart').addEventListener('click', () => {
      startUserWatch();
      startBusLoop();
    });
    document.getElementById('btnStop').addEventListener('click', () => {
      stopUserWatch();
      stopBusLoop();
    });
    document.getElementById('btnCenter').addEventListener('click', () => {
      if (userLatLng) map.setView(userLatLng, 15);
    });

    // Initial map position
    map.setView([20.5937, 78.9629], 5); // India
  </script>
</body>
</html>
