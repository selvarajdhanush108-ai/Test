<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bus Tracker Live</title>

        <!-- TailwindCSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Leaflet CSS & JS -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <!-- Socket.IO -->
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

        <style>
            #map {
                height: 80vh;
            }
            .bus-popup {
                min-width: 200px;
            }

            /* Floating button */
            #setHomeBtn {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #22c55e;
                color: #fff;
                border: none;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                font-size: 28px;
                font-weight: 700;
                cursor: pointer;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
                z-index: 9999;
            }

            /* Toast */
            #toast {
                position: fixed;
                top: 14px;
                left: 50%;
                transform: translateX(-50%);
                background: #111827;
                color: #fff;
                padding: 10px 16px;
                border-radius: 999px;
                font-weight: 700;
                display: none;
                z-index: 10000;
                border: 1px solid rgba(255, 255, 255, 0.15);
            }
        </style>
    </head>
    <body class="bg-gray-100 flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-indigo-600 text-white py-4 shadow-md">
            <h1 class="text-center text-2xl sm:text-3xl font-bold">
                üöå Bus Tracker Live
            </h1>
        </header>

        <!-- Controls -->
        <div
            class="flex flex-col sm:flex-row items-center justify-center gap-3 p-4 bg-white shadow-md"
        >
            <input
                type="text"
                id="busId"
                placeholder="Enter Bus ID"
                class="border rounded-lg px-4 py-2 w-full sm:w-1/3 focus:ring-2 focus:ring-indigo-500 outline-none"
            />
            <button
                id="findBtn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg shadow-md transition-all"
            >
                Start Tracking
            </button>
            <span
                id="status"
                class="text-gray-700 text-sm sm:text-base ml-2"
            ></span>
        </div>

        <!-- Map -->
        <div id="map" class="w-full flex-1 shadow-inner"></div>

        <!-- Floating Button + Toast -->
        <button id="setHomeBtn" title="Set / Update Home">üè†</button>
        <div id="toast">Bus is near your home! üöç</div>

        <script>
            // ---------------- Map Setup ----------------
            const map = L.map("map").setView([20.5937, 78.9629], 5);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
            }).addTo(map);

            const socket = io("https://bus-tracker-server-ajmu.onrender.com");

            const busIcon = L.icon({
                iconUrl: "https://img.icons8.com/color/48/000000/bus.png",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -25],
            });

            let busMarker = null;
            let trackingBusId = null;
            const statusEl = document.getElementById("status");
            const findBtn = document.getElementById("findBtn");

            function startTracking() {
                trackingBusId = document.getElementById("busId").value.trim();
                if (!trackingBusId) {
                    statusEl.textContent = "Enter a Bus ID";
                    return;
                }
                statusEl.textContent = `Tracking bus ${trackingBusId}...`;
                findBtn.textContent = "Stop Tracking";
                findBtn.classList.add("stop");
            }
            function stopTracking() {
                trackingBusId = null;
                statusEl.textContent = "Tracking stopped";
                findBtn.textContent = "Start Tracking";
                findBtn.classList.remove("stop");
                if (busMarker) {
                    map.removeLayer(busMarker);
                    busMarker = null;
                }
            }
            findBtn.addEventListener("click", () => {
                if (!trackingBusId) startTracking();
                else stopTracking();
            });

            // ---------------- Toast & Buzzer ----------------
            const toast = document.getElementById("toast");
            let audioCtx = null;
            let audioReady = false;
            function ensureAudio() {
                if (audioReady) return;
                try {
                    audioCtx = new (window.AudioContext ||
                        window.webkitAudioContext)();
                    audioReady = true;
                } catch (e) {
                    console.warn("Audio not available", e);
                }
            }
            function showToast(msg, ms = 1800) {
                toast.textContent = msg;
                toast.style.display = "block";
                setTimeout(() => (toast.style.display = "none"), ms);
            }
            function buzzer(durationMs = 2500, freq = 1000) {
                if (!audioReady || !audioCtx) return;
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = "square";
                o.frequency.value = freq;
                g.gain.value = 0.25;
                o.connect(g).connect(audioCtx.destination);
                o.start();
                setTimeout(() => o.stop(), durationMs);
            }

            // ---------------- Home Location (persistent) ----------------
            const DISTANCE_THRESHOLD = 2000; // meters (2 km)
            let home = null; // { lat, lng, accuracy, savedAt }
            let homeMarker = null;
            let homeCircle = null; // 2km radius circle

            // Load any saved home from localStorage
            (function loadHome() {
                const saved = localStorage.getItem("homeLocation");
                if (saved) {
                    try {
                        home = JSON.parse(saved);
                    } catch {}
                }
                if (
                    home &&
                    typeof home.lat === "number" &&
                    typeof home.lng === "number"
                ) {
                    drawHome();
                }
            })();

            function drawHome() {
                if (!home) return;
                // marker
                if (homeMarker) map.removeLayer(homeMarker);
                homeMarker = L.marker([home.lat, home.lng], {
                    icon: L.icon({
                        iconUrl:
                            "https://img.icons8.com/ios-filled/50/228BE6/home.png",
                        iconSize: [35, 35],
                        iconAnchor: [17, 34],
                    }),
                })
                    .addTo(map)
                    .bindPopup(`üè† Home<br/>Acc: ${home.accuracy ?? "‚Äî"} m`);
                // 2km circle
                if (homeCircle) map.removeLayer(homeCircle);
                homeCircle = L.circle([home.lat, home.lng], {
                    radius: DISTANCE_THRESHOLD,
                    color: "#2563eb",
                    weight: 2,
                    fillOpacity: 0.06,
                }).addTo(map);
            }

            // ---- Accurate capture using watchPosition (ported from index2 style)
            let setHomeWatchId = null;
            function setHomeAccurate() {
                if (!("geolocation" in navigator)) {
                    alert("Geolocation not supported.");
                    return;
                }
                ensureAudio(); // user gesture prepares audio for later alerts
                audioCtx &&
                    audioCtx.resume &&
                    audioCtx.resume().catch(() => {});

                // Track best fix for up to TIMEOUT_MS or until TARGET_ACC met
                const TARGET_ACC = 30; // meters
                const TIMEOUT_MS = 15000; // 15s
                let best = null;
                let started = Date.now();

                // show progress
                showToast("Getting accurate location‚Ä¶");

                setHomeWatchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude, accuracy } = pos.coords;
                        // store best (lowest accuracy)
                        if (!best || (accuracy && accuracy < best.accuracy)) {
                            best = { lat: latitude, lng: longitude, accuracy };
                            // live feedback
                            showToast(`Accuracy: ${Math.round(accuracy)} m`);
                        }
                        // stop early if good enough
                        if (best && best.accuracy <= TARGET_ACC) {
                            finalizeHome(best);
                        } else if (Date.now() - started > TIMEOUT_MS) {
                            // timeout fallback to best we have
                            finalizeHome(
                                best || {
                                    lat: latitude,
                                    lng: longitude,
                                    accuracy,
                                },
                            );
                        }
                    },
                    (err) => {
                        console.warn("Geolocation error:", err);
                        alert("Failed to get location: " + err.message);
                        clearHomeWatch();
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 },
                );
            }

            function clearHomeWatch() {
                if (setHomeWatchId != null) {
                    navigator.geolocation.clearWatch(setHomeWatchId);
                    setHomeWatchId = null;
                }
            }

            function finalizeHome(best) {
                clearHomeWatch();
                if (!best) {
                    alert("Could not determine location.");
                    return;
                }
                home = {
                    lat: best.lat,
                    lng: best.lng,
                    accuracy: Math.round(best.accuracy || 0),
                    savedAt: Date.now(),
                };
                localStorage.setItem("homeLocation", JSON.stringify(home));
                drawHome();
                map.setView([home.lat, home.lng], 15);
                showToast(`Home saved (¬±${home.accuracy} m)`);
            }

            document
                .getElementById("setHomeBtn")
                .addEventListener("click", setHomeAccurate);

            // ---------------- Proximity Alert ----------------
            let lastAlertTime = 0;
            function checkBusProximity(lat, lng) {
                if (!home) return;
                const homeLatLng = L.latLng(home.lat, home.lng);
                const busLatLng = L.latLng(lat, lng);
                const d = homeLatLng.distanceTo(busLatLng); // meters
                if (isNaN(d)) return;

                // Throttle alerts to once per 15s
                const now = Date.now();
                if (d <= DISTANCE_THRESHOLD && now - lastAlertTime > 15000) {
                    lastAlertTime = now;
                    showToast(`Bus is ${Math.round(d)} m from home! üöç`);
                    buzzer(3000, 900);
                    if (navigator.vibrate)
                        navigator.vibrate([400, 200, 400, 200, 800]);
                }
            }

            // ---------------- Bus Updates ----------------
            socket.on("busLocationUpdate", (data) => {
                if (!trackingBusId || data.busId !== trackingBusId) return;

                const lat = data.latitude;
                const lng = data.longitude;
                const timestamp = data.timestamp;
                if (typeof lat !== "number" || typeof lng !== "number") return;

                checkBusProximity(lat, lng);

                const popupContent = `
        <div class="bus-popup p-2">
          <div class="font-semibold text-indigo-700 text-lg">Bus: ${data.busId}</div>
          <div class="text-gray-700">Lat: ${lat.toFixed(5)}</div>
          <div class="text-gray-700">Lng: ${lng.toFixed(5)}</div>
          <div class="text-gray-600">Time (IST): ${timestamp ?? "‚Äî"}</div>
        </div>
      `;

                if (!busMarker) {
                    busMarker = L.marker([lat, lng], { icon: busIcon })
                        .addTo(map)
                        .bindPopup(popupContent)
                        .openPopup();
                    map.setView([lat, lng], 15);
                } else {
                    busMarker.setLatLng([lat, lng]);
                    busMarker.getPopup()?.setContent(popupContent);
                }

                statusEl.textContent = `Bus ${data.busId} at ${lat.toFixed(5)}, ${lng.toFixed(5)}${timestamp ? " (Time: " + timestamp + ")" : ""}`;
            });
        </script>
    </body>
</html>
