<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Tracker Live</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    #map { height: 80vh; }
    .bus-popup { min-width: 200px; }

    /* Floating button */
    #setHomeBtn {
      position: fixed; bottom: 20px; right: 20px;
      background: #22c55e; color: #fff; border: none;
      border-radius: 50%; width: 60px; height: 60px;
      font-size: 28px; font-weight: 700; cursor: pointer;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); z-index: 9999;
    }

    /* Toast */
    #toast {
      position: fixed; top: 14px; left: 50%; transform: translateX(-50%);
      background: #111827; color: #fff; padding: 10px 16px;
      border-radius: 999px; font-weight: 700; display: none;
      z-index: 10000; border: 1px solid rgba(255,255,255,0.15);
    }

    /* Modal */
    #alertModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; justify-content: center;
      align-items: center; z-index: 20000;
    }
    #alertBox {
      background: white; color: black; padding: 20px; border-radius: 16px;
      width: 90%; max-width: 400px; text-align: center; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    #alertBox button {
      background: #ef4444; color: white; padding: 10px 20px; border: none;
      border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 10px;
    }
    #alertIcon {
      font-size: 50px; margin-bottom: 10px; color: #ef4444;
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow-md">
    <h1 class="text-center text-2xl sm:text-3xl font-bold">üöå Bus Tracker Live</h1>
  </header>

  <!-- Controls -->
  <div class="flex flex-col sm:flex-row items-center justify-center gap-3 p-4 bg-white shadow-md">
    <input type="text" id="busId" placeholder="Enter Bus ID"
      class="border rounded-lg px-4 py-2 w-full sm:w-1/3 focus:ring-2 focus:ring-indigo-500 outline-none" />
    <button id="findBtn"
      class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg shadow-md transition-all">
      Start Tracking
    </button>
    <span id="status" class="text-gray-700 text-sm sm:text-base ml-2"></span>
  </div>

  <!-- Map -->
  <div id="map" class="w-full flex-1 shadow-inner"></div>

  <!-- Floating Button + Toast -->
  <button id="setHomeBtn" title="Set / Update Home">üè†</button>
  <div id="toast">Bus is near your home! üöç</div>

  <!-- Alert Modal -->
  <div id="alertModal">
    <div id="alertBox">
      <div id="alertIcon">üö®</div>
      <h2 class="text-xl font-bold mb-2">Bus is Near!</h2>
      <p>The bus has entered your 2 km home zone.</p>
      <button id="stopAlertBtn">üîï Stop Alert</button>
    </div>
  </div>

  <script>
    // ---------------- Map Setup ----------------
    const map = L.map("map").setView([20.5937, 78.9629], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const socket = io("https://bus-tracker-server-ajmu.onrender.com");

    const busIcon = L.icon({
      iconUrl: "https://img.icons8.com/color/48/000000/bus.png",
      iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -25],
    });

    let busMarker = null;
    let trackingBusId = null;
    const statusEl = document.getElementById("status");
    const findBtn = document.getElementById("findBtn");

    function startTracking() {
      trackingBusId = document.getElementById("busId").value.trim();
      if (!trackingBusId) { statusEl.textContent = "Enter a Bus ID"; return; }
      statusEl.textContent = `Tracking bus ${trackingBusId}...`;
      findBtn.textContent = "Stop Tracking"; findBtn.classList.add("stop");
    }
    function stopTracking() {
      trackingBusId = null; statusEl.textContent = "Tracking stopped";
      findBtn.textContent = "Start Tracking"; findBtn.classList.remove("stop");
      if (busMarker) { map.removeLayer(busMarker); busMarker = null; }
    }
    findBtn.addEventListener("click", () => { if (!trackingBusId) startTracking(); else stopTracking(); });

    // ---------------- Toast ----------------
    const toast = document.getElementById("toast");
    function showToast(msg, ms = 1800) {
      toast.textContent = msg; toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", ms);
    }

    // ---------------- Continuous Alert with 1-hour Snooze ----------------
    const alertModal = document.getElementById("alertModal");
    const stopAlertBtn = document.getElementById("stopAlertBtn");
    let alertActive = false;
    let snoozeUntil = 0;
    let buzzerNode = null;
    let vibrationInterval = null;
    let audioCtx = null;

    function ensureAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } 
        catch(e) { console.warn("Audio not available", e); }
      }
    }

    function startContinuousAlert() {
      if (alertActive || Date.now() < snoozeUntil) return;
      alertActive = true;
      alertModal.style.display = "flex";
      ensureAudio();

      // Continuous buzzer
      buzzerNode = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      buzzerNode.type = "square"; buzzerNode.frequency.value = 900;
      gain.gain.value = 0.25;
      buzzerNode.connect(gain).connect(audioCtx.destination);
      buzzerNode.start();

      // Continuous vibration
      if (navigator.vibrate) {
        vibrationInterval = setInterval(() => {
          navigator.vibrate([300, 200, 300, 200, 600]);
        }, 2000);
      }
    }

    function stopContinuousAlert() {
      alertActive = false;
      snoozeUntil = Date.now() + 60 * 60 * 1000; // snooze 1 hour
      alertModal.style.display = "none";

      if (buzzerNode) { buzzerNode.stop(); buzzerNode.disconnect(); buzzerNode = null; }
      if (vibrationInterval) { clearInterval(vibrationInterval); vibrationInterval = null; }

      showToast("Alerts snoozed for 1 hour");
    }
    stopAlertBtn.addEventListener("click", stopContinuousAlert);

    // ---------------- Home Location ----------------
    const DISTANCE_THRESHOLD = 2000; // meters
    let home = null, homeMarker = null, homeCircle = null;

    (function loadHome() {
      const saved = localStorage.getItem("homeLocation");
      if (saved) try { home = JSON.parse(saved); } catch {}
      if (home && typeof home.lat === "number" && typeof home.lng === "number") drawHome();
    })();

    function drawHome() {
      if (!home) return;
      if (homeMarker) map.removeLayer(homeMarker);
      homeMarker = L.marker([home.lat, home.lng], {
        icon: L.icon({
          iconUrl: "https://img.icons8.com/ios-filled/50/228BE6/home.png",
          iconSize: [35, 35], iconAnchor: [17, 34],
        }),
      }).addTo(map).bindPopup(`üè† Home<br/>Acc: ${home.accuracy ?? "‚Äî"} m`);
      if (homeCircle) map.removeLayer(homeCircle);
      homeCircle = L.circle([home.lat, home.lng], {
        radius: DISTANCE_THRESHOLD, color: "#2563eb", weight: 2, fillOpacity: 0.06,
      }).addTo(map);
    }

    let setHomeWatchId = null;
    document.getElementById("setHomeBtn").addEventListener("click", () => {
      if (!("geolocation" in navigator)) { alert("Geolocation not supported."); return; }
      ensureAudio();
      audioCtx?.resume?.().catch(()=>{});
      showToast("Getting accurate location‚Ä¶");

      const TARGET_ACC = 30, TIMEOUT_MS = 15000;
      let best = null, start = Date.now();

      setHomeWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          if (!best || accuracy < best.accuracy) {
            best = { lat: latitude, lng: longitude, accuracy };
            showToast(`Accuracy: ${Math.round(accuracy)} m`);
          }
          if ((best && best.accuracy <= TARGET_ACC) || Date.now() - start > TIMEOUT_MS)
            finalizeHome(best);
        },
        (err) => { console.warn("Geo error", err); alert("Failed: " + err.message); clearWatch(); },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
      );
    });

    function clearWatch() { if (setHomeWatchId!=null){navigator.geolocation.clearWatch(setHomeWatchId); setHomeWatchId=null;} }
    function finalizeHome(best) {
      clearWatch();
      if (!best) { alert("No fix."); return; }
      home = { lat: best.lat, lng: best.lng, accuracy: Math.round(best.accuracy||0), savedAt: Date.now() };
      localStorage.setItem("homeLocation", JSON.stringify(home));
      drawHome(); map.setView([home.lat, home.lng], 15);
      showToast(`Home saved (¬±${home.accuracy} m)`);
    }

    // ---------------- Proximity Alert ----------------
    let lastAlertTime = 0;
    function checkBusProximity(lat, lng) {
      if (!home || Date.now() < snoozeUntil) return;
      const d = L.latLng(home.lat, home.lng).distanceTo([lat, lng]);
      if (isNaN(d)) return;
      const now = Date.now();
      if (d <= DISTANCE_THRESHOLD && !alertActive && now - lastAlertTime > 5000) {
        lastAlertTime = now; startContinuousAlert();
      }
    }

    // ---------------- Bus Updates ----------------
    socket.on("busLocationUpdate", (data) => {
      if (!trackingBusId || data.busId !== trackingBusId) return;
      const lat = data.latitude, lng = data.longitude, t = data.timestamp;
      if (typeof lat!=="number"||typeof lng!=="number") return;
      checkBusProximity(lat,lng);

      const popup = `
        <div class="bus-popup p-2">
          <div class="font-semibold text-indigo-700 text-lg">Bus: ${data.busId}</div>
          <div class="text-gray-700">Lat: ${lat.toFixed(5)}</div>
          <div class="text-gray-700">Lng: ${lng.toFixed(5)}</div>
          <div class="text-gray-600">Time: ${t ?? "‚Äî"}</div>
        </div>`;
      if (!busMarker) {
        busMarker = L.marker([lat,lng],{icon:busIcon}).addTo(map).bindPopup(popup).openPopup();
        map.setView([lat,lng],15);
      } else { busMarker.setLatLng([lat,lng]); busMarker.getPopup()?.setContent(popup); }
      statusEl.textContent = `Bus ${data.busId} @ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    });
  </script>
</body>
</html>
